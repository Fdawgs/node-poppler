language: node_js

cache: yarn

node_js:
    - 'lts/*'
    - 'node'

os:
    - windows
    - osx

# See https://travis-ci.community/t/build-doesnt-finish-after-completing-tests/288/9
env:
    - YARN_GPG=no

# safelist
branches:
    only:
        - master
        - /^feat/.*$/
        - /^v\d*\.\d*\.\d*$/
        - /^dependabot/.*$/

script: echo "Running tests against $(node -v)..."

jobs:
    allow_failures:
        - os: osx
    include:
        - stage: Produce Coverage
          node_js: node
          script: jest --coverage && cat ./coverage/lcov.info | ./node_modules/coveralls/bin/coveralls.js && rm -rf ./coverage
        - stage: Check for Code Duplication
          node_js: node
          script: yarn dupe-check
        - stage: NPM release
          deploy:
            provider: npm
            email: devfrazs@outlook.com
            api_key:
                secure: dQvO0/mBJxWJrd6r5XJYA/4ugeD3ZYH68ZsRaCZJm6woft9AR7Zs8d4bd/7n6TFCzEMwU++Qep9dE9qEvkX9Fi3NBU5AU+txzu1fjKobSiPNbr3Bd5Wl6GMndQrWtRJkxyRR4DI14VovgkgWmgzWwA9DkeyF8/48C1N8nvWsV2yF/ROzvsF4Mr81V7ZLF6dFJzZPEQAvppdGRRvaKb6IbDt+mamrG5CtHWQwfCueDRFQxbJyNg+dftDeLMN2/044j7BuckgQHIBqSH/zNmUFIk2qOG/xpJ0jew7Km+pMnqxHmWcO7BjQt5Aqs3/mj2b8mWqp8kcIy/t5pva4BS/Y/zCCVOmkugiUSCFjmu7ucPbKEq8OmmUSNkysbhAkq2M8yxqM/d4+o5rH2f+EsznmFF4SIT1BMhe5VZyNkA4GmnbdBhbVUf3btx8CZ9tLg0FbZ+Y7sUnVhTvtfjDY//fiJlJ2lFXp3qL2tNMLFipKERaJxnqspf7+28TWZE80QeIGsd9jMmbLlPUFBO/+XiJVAzO4verNMhzYo1iH6YUeytxc+xbwNr7q7DS+HP8NG+9x1rUa3VsL9ZtVDhwu76yheMLJrmm9iTQG35M5EnnwFg59S/bnqx/p5HcF2spVcqHdR9NhXrR98GcQaQvoJYD5SKy31+lWJeD0VRwiMzkmyzI=
            on:
                tags: true